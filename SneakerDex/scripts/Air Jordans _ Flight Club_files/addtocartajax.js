var AddToCartAjax=Class.create({initialize:function(options){var defaults={addUrl:"",addFromWishlistUrl:"",removeUrl:"",redirectUrl:"",overlayHexColorCode:"",overlayOpacity:"0.5",popupTimeout:"10",popupFadeoutDuration:"0.5",defaultQty:"1",confirmDeleteMessage:"",popupWidth:"255",afterCartUpdateFunc:null,showPopupWhenAdding:!0,beforeAddFunc:null};this.options=Object.extend(defaults,options),this.options.popupTimeout=parseInt(1e3*parseFloat(this.options.popupTimeout))},add:function(clickedNode,productId,buyRelated,callback,serialPair){if(this.callback="function"==typeof callback?callback:this.callback=function(){console.log("cart call back missing")},this.serialPair="string"==typeof serialPair?serialPair:"",this.options.beforeAddFunc&&!this.options.beforeAddFunc())return!1;if(this.buyRelated="undefined"!=typeof buyRelated&&""!==buyRelated&&buyRelated,this.isLoading)return!1;var qty=this.options.defaultQty;null!=$("qty_"+productId)&&(qty=$F("qty_"+productId));var params="",formNode=$(clickedNode).up("form");if(this.parent=$(clickedNode).up(".item"),"undefined"==typeof formNode)params="product="+productId+"&qty="+qty;else{var varienForm=new VarienForm($(formNode).readAttribute("id"));if(!varienForm.validator.validate())return!1;params=$(formNode).serialize(),params+="&product="+productId}this.buyRelated?(params+="&buyRelated="+this.buyRelated,this.showRelated(),this.isLoading=!0):(params+="&buyRelated="+this.buyRelated,this.isLoading=!0,this.resetPopup(),"1"==this.options.showPopupWhenAdding&&this.showPopup());new Ajax.Request(this.options.addUrl,{method:"post",parameters:params,onSuccess:this.onSuccess.bind(this),onFailure:this.onFailure.bind(this)});return!0},addByString:function(params,buyRelated){if(this.buyRelated="undefined"!=typeof buyRelated&&buyRelated,this.isLoading)return!1;this.buyRelated?(params+="&buyRelated="+this.buyRelated,this.showRelated(),this.isLoading=!0):(params+="&buyRelated="+this.buyRelated,this.isLoading=!0,this.resetPopup(),this.showPopup());new Ajax.Request(this.options.addUrl,{method:"post",parameters:params,onSuccess:this.onSuccess.bind(this),onFailure:this.onFailure.bind(this)})},addFromWishList:function(itemId){if(this.isLoading)return!1;var params="",qty=1,form=$("wishlist-view-form");if(form){var input=form["qty["+itemId+"]"];input&&(qty=input.value)}params="item="+itemId+"&qty="+qty,this.isLoading=!0,this.resetPopup(),this.showPopup();new Ajax.Request(this.options.addFromWishlistUrl,{method:"post",parameters:params,onSuccess:this.onSuccess.bind(this),onFailure:this.onFailure.bind(this)})},remove:function(clickedNode,productId){return!this.isLoading&&(this.resetPopup(),this.showPopup(),$("atca-button-container").show(),$("atca-continue-btn").hide(),$("atca-redirect-btn").hide(),$("atca-no-btn").show(),$("atca-yes-btn").show(),$("atca-message-text").update(this.options.confirmDeleteMessage),$("atca-message-text").addClassName("atca-notice"),$("atca-message-text").show(),this.productId=productId,void 0)},dontRemove:function(){this.closePopup()},continueRemove:function(){var url=this.options.removeUrl,params="";params+="id/"+this.productId,url+=params,this.isLoading=!0,this.resetPopup(),$("atca-message-text").hide(),$("atca-please-wait-remove").show(),this.isRemoving=!0;new Ajax.Request(url,{method:"get",onSuccess:this.onSuccess.bind(this),onFailure:this.onFailure.bind(this)})},onSuccess:function(transport){if(transport&&transport.responseText){try{response=eval("("+transport.responseText+")")}catch(e){response={}}if($("atca-please-wait-remove").hide(),$("atca-please-wait-related")&&(this.pleaseWaitContainer.hide(),this.pleaseWaitImageContainer.hide()),$("atca-please-wait-related")&&!response.redirectRelated&&(this.relatedtimeout=setTimeout(function(){this.relatedContainer.hide(),this.relatedText.hide(),this.relatedImage.hide()}.bind(this),2e3)),response.redirect)return $("atca-message-text").update(response.redirect.message),$("atca-message-text").addClassName("atca-notice"),$("atca-message-text").show(),window.location=response.redirect.url,!1;if(response.redirectRelated)return $("atca-message-text").hide(),this.relatedText.show(),this.relatedImage.show(),this.relatedText.update(response.redirectRelated.message),this.relatedText.addClassName("atca-notice"),this.relatedImage.addClassName("atca-notice"),window.location=response.redirectRelated.url,!1;if(response.error&&($("atca-message-text").update(response.error.message),$("atca-message-text").addClassName("atca-error"),response.error.html&&$("atca-cart")&&$("atca-cart").update(response.error.html),this.options.afterCartUpdateFunc&&this.options.afterCartUpdateFunc()),response.errorRelated&&($("atca-message-text").hide(),this.relatedText.show(),this.relatedImage.show(),this.relatedText.update(response.errorRelated.message),this.relatedText.addClassName("atca-error"),this.relatedImage.addClassName("atca-error"),response.errorRelated.html&&$("atca-cart")&&($("atca-cart").update(response.errorRelated.html),this.options.afterCartUpdateFunc&&this.options.afterCartUpdateFunc())),response.success){if(this.callback(),$("atca-message-text").update("THE PRODUCT WAS ADDED TO BASKET!"),$("atca-related-container").update(response.success.buyRelated),$("atca-message-text").addClassName("atca-success"),$("atca-cart")){$("atca-cart").update(response.success.html),response.success.html_quickcheckoutcart&&$("quickcheckoutcart-cart-container")&&($("quickcheckoutcart-cart-container").update(response.success.html_quickcheckoutcart),$("quickcheckoutcart-cart-container").fire("quickcheckoutcart:aftercartupdate")),response.success.wishlist_html&&$$(".my-wishlist").each(function(node){node.replace(response.success.wishlist_html)}.bind(this));var itemCountNumber="object"==typeof response.successRelated?response.successRelated.itemCount:response.success.itemCount,itemQtyNumber="object"==typeof response.successRelated?response.successRelated.itemQty:response.success.itemQty;$("atca-cart").fire("addtocartajax:update",{itemCount:itemCountNumber,itemQty:itemQtyNumber}),$("atca-cart").fire("quickcheckout:reload"),this.options.afterCartUpdateFunc&&this.options.afterCartUpdateFunc()}response.cart_is_empty&&($("atca-redirect-btn").hide(),$("atca-continue-btn").setStyle({"float":"none"}))}response.successRelated&&($("atca-message-text").hide(),this.relatedText.show(),this.relatedImage.show(),this.relatedText.update(response.successRelated.message),this.relatedText.addClassName("atca-success"),this.relatedImage.addClassName("atca-success"),$("atca-cart")&&($("atca-cart").update(response.successRelated.html),response.successRelated.html_quickcheckoutcart&&$("quickcheckoutcart-cart-container")&&($("quickcheckoutcart-cart-container").update(response.successRelated.html_quickcheckoutcart),$("quickcheckoutcart-cart-container").fire("quickcheckoutcart:aftercartupdate")),response.successRelated.wishlist_html&&$$(".my-wishlist").each(function(node){node.replace(response.successRelated.wishlist_html)}.bind(this)),$("atca-cart").fire("addtocartajax:update"),$("atca-cart").fire("quickcheckout:reload"),this.options.afterCartUpdateFunc&&this.options.afterCartUpdateFunc()),response.cart_is_empty&&($("atca-redirect-btn").hide(),$("atca-continue-btn").setStyle({"float":"none"}))),response.successRelated||($("atca-message-text").show(),$("atca-related-container").show(),$("atca-button-container").show(),response.success&&$("atca-checkoutbutton")&&$("atca-checkoutbutton").setStyle({display:"block"}),response.success.buyRelated||(this.timeout=setTimeout(function(){this.closePopup()}.bind(this),this.options.popupTimeout))),this.isLoading=!1,this.isRemoving=!1}},onFailure:function(){this.closePopup()},resetPopup:function(){$("atca-continue-btn")&&$("atca-continue-btn").setStyle({"float":"left"}),$("atca-no-btn")&&$("atca-no-btn").hide(),$("atca-yes-btn")&&$("atca-yes-btn").hide(),$("atca-continue-btn")&&$("atca-continue-btn").show(),$("atca-redirect-btn")&&$("atca-redirect-btn").show(),$("atca-message-text")&&$("atca-message-text").hide(),$("atca-related-container")&&$("atca-related-container").hide(),$("atca-button-container")&&$("atca-button-container").hide(),$("atca-message-text")&&$("atca-message-text").removeAttribute("class")},showPopup:function(){if(""!=this.options.overlayHexColorCode){var viewport=document.viewport.getDimensions(),windowHeight=viewport.height,bodyNode=$$("body")[0],bodyHeight=bodyNode.getHeight();bodyHeight>windowHeight&&(windowHeight=bodyHeight),this.overlayObserverHasBeenAdded||($("atca-overlay").observe("click",function(e){this.isLoading||this.closePopup()}.bind(this)),this.overlayObserverHasBeenAdded=!0),$("atca-overlay").setStyle({width:"100%",height:windowHeight+"px",background:this.options.overlayHexColorCode,opacity:this.options.overlayOpacity,zIndex:"199",position:"absolute",top:"0",left:"0",cursor:"pointer",background:"rgba(255,255,255, "+this.options.overlayOpacity+")"}),$("atca-overlay").show()}$("atca-popup-container").setStyle({width:this.options.popupWidth+"px",marginLeft:"-"+this.options.popupWidth/2+"px"}),$("atca-popup-container").show(),this.isRemoving&&$("atca-please-wait-remove").show(),this.centerElementVertically($("atca-popup-container"))},showRelated:function(){this.pleaseWaitContainer=this.parent.down("#atca-please-wait-related"),this.pleaseWaitImageContainer=this.parent.down("#atca-please-wait-image-related"),this.relatedContainer=this.parent.down("#atca-message-text-related-container"),this.relatedText=this.parent.down("#atca-message-text-related"),this.relatedImage=this.parent.down("#atca-message-image-related"),this.relatedText.hide(),this.relatedImage.hide(),this.relatedContainer.show(),this.pleaseWaitContainer.show(),this.pleaseWaitImageContainer.show()},closePopup:function(){clearTimeout(this.timeout),Effect.Fade("atca-popup-container",{duration:this.options.popupFadeoutDuration}),$("messages_product_view")&&Effect.Fade("messages_product_view",{duration:this.options.popupFadeoutDuration}),$("atca-overlay")&&Effect.Fade("atca-overlay",{duration:this.options.popupFadeoutDuration}),this.isLoading=!1},centerElementVertically:function(element){if(null!=$(element)){var viewport=document.viewport.getDimensions(),windowHeight=viewport.height,scrollOffsets=document.viewport.getScrollOffsets(),scrollTop=scrollOffsets.top,yPos=Math.round(windowHeight/2)+scrollTop;yPos-=$(element).getHeight()/2,$(element).setStyle({top:yPos+"px"})}},redirect:function(url){url="undefined"!=typeof url?url:"",""==url&&(url=this.options.redirectUrl),window.location=url}});